<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Openstack RPC</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>

    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Sina Network Platform Team's blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Openstack RPC</h1>
    <p class="meta">Mar 16, 2015</p>
  </header>

  <article class="post-content">
  <h3 id="rabbitmq">RabbitMQ的消息模型</h3>

<p>RabbitMQ 基本概念:</p>

<ul>
  <li>Producer: 消息生产者</li>
  <li>Consumer: 消息消费者</li>
  <li>Exchange: 接受消息的载体</li>
  <li>Message: RabbitMQ中的基本消息单元</li>
  <li>Queue: 存储并接受Exchange分发的消息, 用于Consumer接受消息</li>
  <li>Routing Key: 标识Message, 用于Exchange分发消息的依据</li>
  <li>Binding: Queue与Exchange绑定, 可选的binding key参数用于指定特定的消息(相当于消息的routing key)</li>
</ul>

<p>在RabbitMQ中, 消息是发送给<code>Exchange</code>的, 而不是<code>Queue</code>, <code>Producer</code>将带有<code>Routing Key</code>的消息发送给相应的
<code>Exchange</code>后, 整个消息的发送过程就结束了; 消息的接收是通过<code>Queue</code>完成的, <code>Consumer</code>在RabbitMQ中定义
一个<code>Queue</code>, 与相应的<code>Exchange</code>进行<code>Binding</code>, 在<code>Binding</code>时可指定感兴趣的消息, 通过<code>binding key</code>来完成,这
样消息就会被<code>Exchange</code>根据<code>binding key</code>分发到相应的<code>Queue</code>上,  <code>Consumer</code>接受<code>Queue</code>的消息即可, 
这样整个消息的接收就完成了.</p>

<p><img src="http://www.rabbitmq.com/img/tutorials/python-three-overall.png" alt="img" class="center-image" /></p>

<p>如上图所示, <code>P</code>代表<code>Producer</code>, <code>x</code>代表<code>Exchange</code>, 红色的代表<code>Queue</code>以及相应的queue name, binding表示上
述的<code>Binding</code>过程, <code>C</code>代表<code>Consumer</code>.</p>

<h3 id="rabbitmqexchange">RabbitMQ中的Exchange</h3>

<p>Exchange在RabbitMQ中也有相应的分类:<code>Direct</code> <code>Fanout</code> <code>Topic</code></p>

<p>Exchange的分类是为了实现不同的通信模式</p>

<ul>
  <li>Fanout: 消息将分发给所有与<code>Exchange</code>绑定的<code>Queue</code></li>
  <li>Direct: 消息将通过 <em>完全匹配</em> <code>Routing Key</code>分发到相应的<code>Queue</code></li>
  <li>
    <p>Topic: 消息将通过 <em>正则匹配(支持特殊字符)</em> <code>Routing Key</code>分发到相应的<code>Queue</code></p>

    <p><code>*</code>匹配单个字符<br />
  <code>#</code>匹配0或多个字符</p>
  </li>
</ul>

<p>因此, 当使用<code>Fanout</code>类型的<code>Exchange</code>, 消息将分发至所有与该<code>Exchange</code>绑定的<code>Queue</code>上, 此时不会匹配<code>Routing Key</code>, 
当使用<code>Direct</code>类型的<code>Exchange</code>, 消息将通过<em>完全匹配</em>(<code>Routing Key</code>与<code>Binding Key</code>)被分发至相应的<code>Queue</code>, 同理, 
<code>Topic</code>类型的<code>Exchange</code>会进行<em>正则匹配</em>.</p>

<p>如图, <code>Direct Exchange</code>类型的消息模型:
<img src="http://www.rabbitmq.com/img/tutorials/direct-exchange.png" alt="img" class="center-image" /></p>

<p>如图, <code>Topic Exchange</code>类型的消息模型:
<img src="http://www.rabbitmq.com/img/tutorials/python-five.png" alt="img" class="center-image" /></p>

<p>从两种类型的<code>Exchange</code>可以看出, 区别仅在于分发消息时对于<code>Routing Key</code>的匹配方式, <code>Direct</code>是<em>完全匹配</em><code>Queue</code>的<code>Binding Key</code>, 
<code>Topic</code>则是使用<em>正则匹配</em>.</p>

<h3 id="openstack-rpc">Openstack RPC</h3>

<p>在Openstack中, 组件内的通信主要通过消息队列完成, 这样可以使整个系统以松耦合的方式进行协作, 以RabbitMQ为例,
Openstack实现了组件间的RPC调用, 主要包括<em>同步</em>和<em>异步</em>两种调用方式:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="sd">&quot;&quot;&quot;oslo/messaging/rpc/client.py&quot;&quot;&quot;</span>
<span class="lineno"> 2</span>     <span class="k">class</span> <span class="nc">RPCClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>         <span class="sd">&quot;&quot;&quot;A class for invoking methods on remote servers.</span>
<span class="lineno"> 5</span> <span class="sd">        The RPCClient class is responsible for sending method invocations to remote</span>
<span class="lineno"> 6</span> <span class="sd">        servers via a messaging transport.</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="sd">        A cast() invocation just sends the request and returns immediately. </span>
<span class="lineno"> 9</span> <span class="sd">        A call() invocation waits for the server to send a return value.</span>
<span class="lineno">10</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>         <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno">13</span>             <span class="sd">&quot;&quot;&quot;Invoke a method and return immediately.</span>
<span class="lineno">14</span> <span class="sd">            &quot;&quot;&quot;</span>
<span class="lineno">15</span>             <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="lineno">16</span>         <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno">17</span>             <span class="sd">&quot;&quot;&quot;Invoke a method and wait for a reply.</span>
<span class="lineno">18</span> <span class="sd">            &quot;&quot;&quot;</span></code></pre></div>

<p>插入的代码只是RPCClient实现的一部分, 从注释可以看出, <code>cast函数</code>属于异步调用, <code>call函数</code>属于同步调用.</p>

<h3 id="cast">cast实现方式</h3>
<p><img src="http://docs.openstack.org/developer/nova/_images/flow2.png" alt="img" class="center-image" /></p>

<ol>
  <li>rpc调用方会初始化<code>Topic Publisher</code>, 将消息以<code>Routing Key</code>为topic发送至配置的<code>Exchange</code>中</li>
  <li>
    <p>rpc接收方会初始化两个<code>Topic Cosumer</code>, 分别通过topic和topic.host为<code>binding key</code>将<code>Queue</code>与<code>Exchange</code>绑定, 
这样接收方就可以接收这两种类型的rpc message</p>

    <p><code>topic</code>即为消息的<code>Routing Key</code>, 所以接收方可以接受到调用方的rpc message.<br />
 <code>topic.host</code>为特定的host上的接收方获取rpc message的方式, 例如: l3-agent.host1(通知host1上的l3-agent进行相关rpc调用)</p>
  </li>
</ol>

<h3 id="call">call实现方式</h3>
<p><img src="http://docs.openstack.org/developer/nova/_images/flow1.png" alt="img" class="center-image" /></p>

<ol>
  <li>rpc调用方初始化<code>Topic Publisher</code>用于发送rpc message, 同时初始化一个<code>Direct Consumer</code>用于接收返回的rpc调用结果, 
为了保证收到相应的rpc调用的结果, rpc message中会保存一个唯一标识该消息的messga id(UUID类型), 消息以<code>Routing Key</code>为topic发送至
<code>Exchange</code>中</li>
  <li>rpc接收方会初始化两个<code>Topic Cosumer</code>, 分别通过topic和topic.host为<code>binding key</code>将<code>Queue</code>与<code>Exchange</code>绑定, rpc
接收方执行rpc调用, 完成后通过<code>Direct Publisher</code>将结果发送到消息队列中, 返回的执行结果message的<code>Routing Key</code>为message id
(唯一的UUID), 将被发送至<code>Exchange</code>(名称同样是唯一的message id), 那样调用方的<code>Direct Consumer</code>就可以收到rpc调用的结果了.</li>
</ol>

<h3 id="ovsneutronagentrpc">以ovs_neutron_agent为例理解rpc的实现</h3>

<p>在ovs_neutron_agent的代码中, rpc的初始化如下:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="sd">&quot;&quot;&quot;plugins/openvswitch/agent/ovs_neutron_agent.py&quot;&quot;&quot;</span>
<span class="lineno"> 2</span>     <span class="k">def</span> <span class="nf">setup_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>         <span class="o">......</span>
<span class="lineno"> 5</span>         <span class="c">#作为rpc调用方的初始化</span>
<span class="lineno"> 6</span>         <span class="bp">self</span><span class="o">.</span><span class="n">plugin_rpc</span> <span class="o">=</span> <span class="n">OVSPluginApi</span><span class="p">(</span><span class="n">topics</span><span class="o">.</span><span class="n">PLUGIN</span><span class="p">)</span>   <span class="c">#与ml2 plgin通信</span>
<span class="lineno"> 7</span>         <span class="bp">self</span><span class="o">.</span><span class="n">state_rpc</span> <span class="o">=</span> <span class="n">agent_rpc</span><span class="o">.</span><span class="n">PluginReportStateAPI</span><span class="p">(</span><span class="n">topics</span><span class="o">.</span><span class="n">PLUGIN</span><span class="p">)</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>         <span class="c">#作为rpc接收方的初始化</span>
<span class="lineno">10</span>         <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">topics</span><span class="o">.</span><span class="n">AGENT</span>
<span class="lineno">11</span>         <span class="c"># Handle updates from service</span>
<span class="lineno">12</span>         <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
<span class="lineno">13</span>         <span class="c"># Define the listening consumers for the agent</span>
<span class="lineno">14</span>         <span class="n">consumers</span> <span class="o">=</span> <span class="p">[[</span><span class="n">topics</span><span class="o">.</span><span class="n">PORT</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">],</span>
<span class="lineno">15</span>                      <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">NETWORK</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">DELETE</span><span class="p">],</span>
<span class="lineno">16</span>                      <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">TUNNEL</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">],</span>
<span class="lineno">17</span>                      <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">SECURITY_GROUP</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">],</span>
<span class="lineno">18</span>                      <span class="p">[</span><span class="n">topics</span><span class="o">.</span><span class="n">DVR</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">]]</span>
<span class="lineno">19</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_pop</span><span class="p">:</span>
<span class="lineno">20</span>             <span class="n">consumers</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">topics</span><span class="o">.</span><span class="n">L2POPULATION</span><span class="p">,</span>
<span class="lineno">21</span>                               <span class="n">topics</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">])</span>
<span class="lineno">22</span>         <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">agent_rpc</span><span class="o">.</span><span class="n">create_consumers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="p">,</span>
<span class="lineno">23</span>                                                      <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span>
<span class="lineno">24</span>                                                      <span class="n">consumers</span><span class="p">)</span>
<span class="lineno">25</span>         <span class="o">......</span></code></pre></div>

<p>self.topic为ovs_neutron_agent会接收的rpc message的类型前缀, 在topics.py中定义:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="sd">&quot;&quot;&quot;common/topics.py&quot;&quot;&quot;</span>
<span class="lineno">2</span>     <span class="n">AGENT</span> <span class="o">=</span> <span class="s">&#39;q-agent-notifier&#39;</span></code></pre></div>

<p>在neutron中, 消息可以分为不同的类型, 以AGENT=’q-agent-notifier’为例, 表示为通知agent端的消息类型.</p>

<p>self.consumers为ovs_neutron_agent会接收的rpc message的具体类型, 在agent_rpc.create_consumers()函数中, 完成了consumers的初始化:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="sd">&quot;&quot;&quot;agent/rpc.py&quot;&quot;&quot;</span>
<span class="lineno"> 2</span>     <span class="k">def</span> <span class="nf">create_consumers</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">topic_details</span><span class="p">):</span>
<span class="lineno"> 3</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 4</span> <span class="sd">        :param endpoints: The list of endpoints to process the incoming messages.</span>
<span class="lineno"> 5</span> <span class="sd">        :param prefix: Common prefix for the plugin/agent message queues.</span>
<span class="lineno"> 6</span> <span class="sd">        :param topic_details: A list of topics. Each topic has a name, an</span>
<span class="lineno"> 7</span> <span class="sd">                              operation, and an optional host param keying the</span>
<span class="lineno"> 8</span> <span class="sd">                              subscription to topic.host for plugin calls.</span>
<span class="lineno"> 9</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>         <span class="n">connection</span> <span class="o">=</span> <span class="n">n_rpc</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">12</span>         <span class="k">for</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">topic_details</span><span class="p">:</span>
<span class="lineno">13</span>             <span class="n">topic</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">node_name</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span>
<span class="lineno">14</span>                 <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>             <span class="n">topic_name</span> <span class="o">=</span> <span class="n">topics</span><span class="o">.</span><span class="n">get_topic_name</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
<span class="lineno">17</span>             <span class="n">connection</span><span class="o">.</span><span class="n">create_consumer</span><span class="p">(</span><span class="n">topic_name</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">fanout</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">18</span>             <span class="k">if</span> <span class="n">node_name</span><span class="p">:</span> <span class="c">#node_name即为host name</span>
<span class="lineno">19</span>                 <span class="n">node_topic_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">topic_name</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
<span class="lineno">20</span>                 <span class="n">connection</span><span class="o">.</span><span class="n">create_consumer</span><span class="p">(</span><span class="n">node_topic_name</span><span class="p">,</span>
<span class="lineno">21</span>                                            <span class="n">endpoints</span><span class="p">,</span>
<span class="lineno">22</span>                                            <span class="n">fanout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno">23</span>         <span class="n">connection</span><span class="o">.</span><span class="n">consume_in_threads</span><span class="p">()</span>
<span class="lineno">24</span>         <span class="k">return</span> <span class="n">connection</span></code></pre></div>

<p>这里需要关注的就是create_consumer函数, 以及传递给该函数的参数topic_name, endpoints, 对于fanout参数, 当
host存在时, 就不需要fanout类型, 因为只需要特定的host接收. topic_name为prefix + topic + operation, 例如:
<code>q-agent-notifier-port-update</code>, <code>q-agent-notifier-port-update.hostname</code>, <code>q-agent-notifier-security_grout-update</code>等, 
这些例子就会作为topic_name传递给create_consumer函数, endpoints为执行rpc函数的载体, 此处应该传递的:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>  <span class="c">#上面的setup_rpc函数中, 即为实例本身</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">def</span> <span class="nf">get_server</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno"> 2</span>         <span class="k">assert</span> <span class="n">TRANSPORT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="lineno"> 3</span>         <span class="n">serializer</span> <span class="o">=</span> <span class="n">RequestContextSerializer</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>
<span class="lineno"> 4</span>         <span class="k">return</span> <span class="n">messaging</span><span class="o">.</span><span class="n">get_rpc_server</span><span class="p">(</span><span class="n">TRANSPORT</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="lineno"> 5</span>                                         <span class="s">&#39;eventlet&#39;</span><span class="p">,</span> <span class="n">serializer</span><span class="p">)</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">10</span>             <span class="nb">super</span><span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="lineno">11</span>             <span class="bp">self</span><span class="o">.</span><span class="n">servers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>         <span class="k">def</span> <span class="nf">create_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">fanout</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
<span class="lineno">14</span>             <span class="n">target</span> <span class="o">=</span> <span class="n">messaging</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span>
<span class="lineno">15</span>                 <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">fanout</span><span class="o">=</span><span class="n">fanout</span><span class="p">)</span>
<span class="lineno">16</span>             <span class="n">server</span> <span class="o">=</span> <span class="n">get_server</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">)</span>
<span class="lineno">17</span>             <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>         <span class="k">def</span> <span class="nf">consume_in_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">20</span>             <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
<span class="lineno">21</span>                 <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="lineno">22</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>     <span class="c"># functions</span>
<span class="lineno">25</span>     <span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno">26</span>         <span class="k">return</span> <span class="n">Connection</span><span class="p">()</span></code></pre></div>

<p>在create_consumer函数中, 首先初始化target, 其作用是封装了关于rpc message相关联的属性, 
比如该消息发送到的<code>Exchange</code>, 消息的topic(Routing Key)等.</p>

<blockquote>
  <p>注意: 在neutron中, 消息的topic其实就是消息发送进<code>Exchange</code>所带有的<code>Routing Key</code>, 比如以topic <code>q-agent-notifier-port-update</code>
为例, 与port-update相关的rpc message应该都是<code>Routing Key</code>为<code>q-agent-notifier-port-update</code>的.</p>
</blockquote>

<p>然后在get_server函数中, serializer为序列化rpc消息的函数, 用于将raw rpc message序列化为适合neutron上下文的dict, 可以不用
深入去看, 明白其含义即可, TRANSPORT为消息的传递载体, 因为openstack中可以使用rabbitmq, 以及zeromq等消息队列, TRANSPOST主要
完成了对相应消息队列功能的封装, 这儿以rabbitmq为消息队列, 也就是说, 消息是通过TRANSPORT(rabbimq)传递的.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">def</span> <span class="nf">get_rpc_server</span><span class="p">(</span><span class="n">transport</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="lineno"> 2</span>                        <span class="n">executor</span><span class="o">=</span><span class="s">&#39;blocking&#39;</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno"> 3</span>         <span class="sd">&quot;&quot;&quot;Construct an RPC server.</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="sd">        The executor parameter controls how incoming messages will be received and</span>
<span class="lineno"> 6</span> <span class="sd">        dispatched. By default, the most simple executor is used - the blocking</span>
<span class="lineno"> 7</span> <span class="sd">        executor.</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="sd">        :param transport: the messaging transport</span>
<span class="lineno">10</span> <span class="sd">        :type transport: Transport</span>
<span class="lineno">11</span> <span class="sd">        :param target: the exchange, topic and server to listen on</span>
<span class="lineno">12</span> <span class="sd">        :type target: Target</span>
<span class="lineno">13</span> <span class="sd">        :param endpoints: a list of endpoint objects</span>
<span class="lineno">14</span> <span class="sd">        :type endpoints: list</span>
<span class="lineno">15</span> <span class="sd">        :param executor: name of a message executor - for example</span>
<span class="lineno">16</span> <span class="sd">                         &#39;eventlet&#39;, &#39;blocking&#39;</span>
<span class="lineno">17</span> <span class="sd">        :type executor: str</span>
<span class="lineno">18</span> <span class="sd">        :param serializer: an optional entity serializer</span>
<span class="lineno">19</span> <span class="sd">        :type serializer: Serializer</span>
<span class="lineno">20</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">21</span>         <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">rpc_dispatcher</span><span class="o">.</span><span class="n">RPCDispatcher</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">serializer</span><span class="p">)</span>
<span class="lineno">22</span>         <span class="k">return</span> <span class="n">msg_server</span><span class="o">.</span><span class="n">MessageHandlingServer</span><span class="p">(</span><span class="n">transport</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">executor</span><span class="p">)</span></code></pre></div>

<p>在messaging.get_rpc_server函数中, 进行了dispatcher的初始化, 它的主要作用为从TRANSPORT中接受感兴趣的消息, 
而target描述了这些感兴趣的消息的属性, target记录了这些信息.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">MessageHandlingServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span>         <span class="sd">&quot;&quot;&quot;Server for handling messages.</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="sd">        Connect a transport to a dispatcher that knows how to process the</span>
<span class="lineno"> 5</span> <span class="sd">        message using an executor that knows how the app wants to create</span>
<span class="lineno"> 6</span> <span class="sd">        new tasks.</span>
<span class="lineno"> 7</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="s">&#39;blocking&#39;</span><span class="p">):</span>
<span class="lineno">10</span>             <span class="sd">&quot;&quot;&quot;Construct a message handling server.</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="sd">            The dispatcher parameter is a callable which is invoked with context</span>
<span class="lineno">13</span> <span class="sd">            and message dictionaries each time a message is received.</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> <span class="sd">            The executor parameter controls how incoming messages will be received</span>
<span class="lineno">16</span> <span class="sd">            and dispatched. By default, the most simple executor is used - the</span>
<span class="lineno">17</span> <span class="sd">            blocking executor.</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="sd">            :param transport: the messaging transport</span>
<span class="lineno">20</span> <span class="sd">            :type transport: Transport</span>
<span class="lineno">21</span> <span class="sd">            :param dispatcher: a callable which is invoked for each method</span>
<span class="lineno">22</span> <span class="sd">            :type dispatcher: callable</span>
<span class="lineno">23</span> <span class="sd">            :param executor: name of message executor - for example</span>
<span class="lineno">24</span> <span class="sd">                             &#39;eventlet&#39;, &#39;blocking&#39;</span>
<span class="lineno">25</span> <span class="sd">            :type executor: str</span>
<span class="lineno">26</span> <span class="sd">            &quot;&quot;&quot;</span>
<span class="lineno">27</span>             <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">transport</span><span class="o">.</span><span class="n">conf</span>
<span class="lineno">28</span> 
<span class="lineno">29</span>             <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">transport</span>
<span class="lineno">30</span>             <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span> <span class="o">=</span> <span class="n">dispatcher</span>
<span class="lineno">31</span>             <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
<span class="lineno">32</span> 
<span class="lineno">33</span>             <span class="k">try</span><span class="p">:</span>
<span class="lineno">34</span>                 <span class="n">mgr</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">DriverManager</span><span class="p">(</span><span class="s">&#39;oslo.messaging.executors&#39;</span><span class="p">,</span>
<span class="lineno">35</span>                                            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">)</span>
<span class="lineno">36</span>             <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<span class="lineno">37</span>                 <span class="k">raise</span> <span class="n">ExecutorLoadFailure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
<span class="lineno">38</span>             <span class="k">else</span><span class="p">:</span>
<span class="lineno">39</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_executor_cls</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">driver</span>
<span class="lineno">40</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno">41</span> 
<span class="lineno">42</span>             <span class="nb">super</span><span class="p">(</span><span class="n">MessageHandlingServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="lineno">43</span> 
<span class="lineno">44</span>         <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">45</span>             <span class="sd">&quot;&quot;&quot;Start handling incoming messages.</span>
<span class="lineno">46</span> <span class="sd">            &quot;&quot;&quot;</span>
<span class="lineno">47</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">48</span>                 <span class="k">return</span>
<span class="lineno">49</span>             <span class="k">try</span><span class="p">:</span>
<span class="lineno">50</span>                 <span class="n">listener</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">_listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">)</span>
<span class="lineno">51</span>             <span class="k">except</span> <span class="n">driver_base</span><span class="o">.</span><span class="n">TransportDriverError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<span class="lineno">52</span>                 <span class="k">raise</span> <span class="n">ServerListenError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
<span class="lineno">53</span> 
<span class="lineno">54</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span>
<span class="lineno">55</span>                                                 <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">)</span>
<span class="lineno">56</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></code></pre></div>

<p>接下来在MessageHandlingServer(transport, dispatcher, executor)中, executor为’blocking’, 表示rpc函数的执行会
阻塞当前线程, 相应的参数还有’eventlet’, 表示在新的eventlet线程中执行, 我们也不需要关心这部分内容, 但是
需要明白其作用. 在上面的start函数中, listener为dispatcher的_listen所返回的结果, 从listener中, 我们就可以
接收到一个一个的消息了, 然后通过self._executor.start(), 开始获取消息并进行相应的rpc调用.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">def</span> <span class="nf">spawn_with</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
<span class="lineno"> 2</span>         <span class="sd">&quot;&quot;&quot;This is the equivalent of a with statement</span>
<span class="lineno"> 3</span> <span class="sd">        but with the content of the BLOCK statement executed</span>
<span class="lineno"> 4</span> <span class="sd">        into a greenthread</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="sd">        exception path grab from:</span>
<span class="lineno"> 7</span> <span class="sd">        http://www.python.org/dev/peps/pep-0343/</span>
<span class="lineno"> 8</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>         <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="nb">exit</span><span class="p">):</span>
<span class="lineno">11</span>             <span class="n">exc</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">12</span>             <span class="k">try</span><span class="p">:</span>
<span class="lineno">13</span>                 <span class="k">try</span><span class="p">:</span>
<span class="lineno">14</span>                     <span class="n">thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="lineno">15</span>                 <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="lineno">16</span>                     <span class="n">exc</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno">17</span>                     <span class="k">if</span> <span class="ow">not</span> <span class="nb">exit</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()):</span>
<span class="lineno">18</span>                         <span class="k">raise</span>
<span class="lineno">19</span>             <span class="k">finally</span><span class="p">:</span>
<span class="lineno">20</span>                 <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
<span class="lineno">21</span>                     <span class="nb">exit</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>         <span class="n">callback</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">.</span><span class="n">__enter__</span><span class="p">()</span>
<span class="lineno">24</span>         <span class="n">thread</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
<span class="lineno">25</span>         <span class="n">thread</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ctxt</span><span class="o">.</span><span class="n">__exit__</span><span class="p">)</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>         <span class="k">return</span> <span class="n">thread</span>
<span class="lineno">28</span> 
<span class="lineno">29</span>     <span class="k">class</span> <span class="nc">EventletExecutor</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">ExecutorBase</span><span class="p">):</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>         <span class="sd">&quot;&quot;&quot;A message executor which integrates with eventlet.</span>
<span class="lineno">32</span> 
<span class="lineno">33</span> <span class="sd">        This is an executor which polls for incoming messages from a greenthread</span>
<span class="lineno">34</span> <span class="sd">        and dispatches each message in its own greenthread.</span>
<span class="lineno">35</span> 
<span class="lineno">36</span> <span class="sd">        The stop() method kills the message polling greenthread and the wait()</span>
<span class="lineno">37</span> <span class="sd">        method waits for all message dispatch greenthreads to complete.</span>
<span class="lineno">38</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">39</span> 
<span class="lineno">40</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">):</span>
<span class="lineno">41</span>             <span class="nb">super</span><span class="p">(</span><span class="n">EventletExecutor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">)</span>
<span class="lineno">42</span>             <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">register_opts</span><span class="p">(</span><span class="n">_eventlet_opts</span><span class="p">)</span>
<span class="lineno">43</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno">44</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_greenpool</span> <span class="o">=</span> <span class="n">greenpool</span><span class="o">.</span><span class="n">GreenPool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">rpc_thread_pool_size</span><span class="p">)</span>
<span class="lineno">45</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno">46</span> 
<span class="lineno">47</span>         <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">48</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">49</span>                 <span class="k">return</span>
<span class="lineno">50</span> 
<span class="lineno">51</span>             <span class="nd">@excutils.forever_retry_uncaught_exceptions</span>
<span class="lineno">52</span>             <span class="k">def</span> <span class="nf">_executor_thread</span><span class="p">():</span>
<span class="lineno">53</span>                 <span class="k">try</span><span class="p">:</span>
<span class="lineno">54</span>                     <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
<span class="lineno">55</span>                         <span class="n">incoming</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">POLL_TIMEOUT</span><span class="p">)</span>
<span class="lineno">56</span>                         <span class="k">if</span> <span class="n">incoming</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">57</span>                             <span class="n">spawn_with</span><span class="p">(</span><span class="n">ctxt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">(</span><span class="n">incoming</span><span class="p">),</span>
<span class="lineno">58</span>                                        <span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_greenpool</span><span class="p">)</span>
<span class="lineno">59</span>                 <span class="k">except</span> <span class="n">greenlet</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">:</span>
<span class="lineno">60</span>                     <span class="k">return</span>
<span class="lineno">61</span> 
<span class="lineno">62</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">63</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_executor_thread</span><span class="p">)</span></code></pre></div>

<p>在self._executor的实现中, start函数的self.listener.poll()函数不断获取rpc消息, 并将新消息在新的eventlet thread中执行, 其中spwan_with中会产生
新的thread, 同时传递给spwan_with的参数为ctxt=self.dispatcher(incoming), 需要特别注意, 因为dispatcher实现了<a href="http://stackoverflow.com/questions/5824881/python-call-special-method-practical-example">__call__</a>方法, 由于
self.dispatcher是一个可调用对象, 因此ctxt=self.dispatcher(incoming)这样的调用是可行的.</p>

<p>现在我们就可以看看在dispatcher中, 消息是怎样得到处理的.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">  1</span> <span class="k">class</span> <span class="nc">RPCDispatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno">  2</span>         <span class="sd">&quot;&quot;&quot;A message dispatcher which understands RPC messages.</span>
<span class="lineno">  3</span> 
<span class="lineno">  4</span> <span class="sd">        A MessageHandlingServer is constructed by passing a callable dispatcher</span>
<span class="lineno">  5</span> <span class="sd">        which is invoked with context and message dictionaries each time a message</span>
<span class="lineno">  6</span> <span class="sd">        is received.</span>
<span class="lineno">  7</span> 
<span class="lineno">  8</span> <span class="sd">        RPCDispatcher is one such dispatcher which understands the format of RPC</span>
<span class="lineno">  9</span> <span class="sd">        messages. The dispatcher looks at the namespace, version and method values</span>
<span class="lineno"> 10</span> <span class="sd">        in the message and matches those against a list of available endpoints.</span>
<span class="lineno"> 11</span> 
<span class="lineno"> 12</span> <span class="sd">        Endpoints may have a target attribute describing the namespace and version</span>
<span class="lineno"> 13</span> <span class="sd">        of the methods exposed by that object. All public methods on an endpoint</span>
<span class="lineno"> 14</span> <span class="sd">        object are remotely invokable by clients.</span>
<span class="lineno"> 15</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 16</span> 
<span class="lineno"> 17</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
<span class="lineno"> 18</span>             <span class="sd">&quot;&quot;&quot;Construct a rpc server dispatcher.</span>
<span class="lineno"> 19</span> 
<span class="lineno"> 20</span> <span class="sd">            :param target: the exchange, topic and server to listen on</span>
<span class="lineno"> 21</span> <span class="sd">            :type target: Target</span>
<span class="lineno"> 22</span> <span class="sd">            &quot;&quot;&quot;</span>
<span class="lineno"> 23</span>     
<span class="lineno"> 24</span>             <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span> <span class="o">=</span> <span class="n">endpoints</span>
<span class="lineno"> 25</span>             <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span> <span class="o">=</span> <span class="n">serializer</span> <span class="ow">or</span> <span class="n">msg_serializer</span><span class="o">.</span><span class="n">NoOpSerializer</span><span class="p">()</span>
<span class="lineno"> 26</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_default_target</span> <span class="o">=</span> <span class="n">msg_target</span><span class="o">.</span><span class="n">Target</span><span class="p">()</span>
<span class="lineno"> 27</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">target</span>
<span class="lineno"> 28</span>     
<span class="lineno"> 29</span>         <span class="k">def</span> <span class="nf">_listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
<span class="lineno"> 30</span>             <span class="k">return</span> <span class="n">transport</span><span class="o">.</span><span class="n">_listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">)</span>
<span class="lineno"> 31</span>     
<span class="lineno"> 32</span>         <span class="nd">@staticmethod</span>
<span class="lineno"> 33</span>         <span class="k">def</span> <span class="nf">_is_namespace</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
<span class="lineno"> 34</span>             <span class="k">return</span> <span class="n">namespace</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">namespace</span>
<span class="lineno"> 35</span>     
<span class="lineno"> 36</span>         <span class="nd">@staticmethod</span>
<span class="lineno"> 37</span>         <span class="k">def</span> <span class="nf">_is_compatible</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="lineno"> 38</span>             <span class="n">endpoint_version</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">version</span> <span class="ow">or</span> <span class="s">&#39;1.0&#39;</span>
<span class="lineno"> 39</span>             <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">version_is_compatible</span><span class="p">(</span><span class="n">endpoint_version</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
<span class="lineno"> 40</span>     
<span class="lineno"> 41</span>         <span class="k">def</span> <span class="nf">_do_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="lineno"> 42</span>             <span class="n">ctxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">deserialize_context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)</span>
<span class="lineno"> 43</span>             <span class="n">new_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="lineno"> 44</span>             <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="lineno"> 45</span>                 <span class="n">new_args</span><span class="p">[</span><span class="n">argname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">deserialize_entity</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
<span class="lineno"> 46</span>             <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">ctxt</span><span class="p">,</span> <span class="o">**</span><span class="n">new_args</span><span class="p">)</span>
<span class="lineno"> 47</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">serialize_entity</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="lineno"> 48</span>     
<span class="lineno"> 49</span>         <span class="nd">@contextlib.contextmanager</span>
<span class="lineno"> 50</span>         <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incoming</span><span class="p">):</span>
<span class="lineno"> 51</span>             <span class="n">incoming</span><span class="o">.</span><span class="n">acknowledge</span><span class="p">()</span>
<span class="lineno"> 52</span>             <span class="k">yield</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_and_reply</span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span>
<span class="lineno"> 53</span>     
<span class="lineno"> 54</span>         <span class="k">def</span> <span class="nf">_dispatch_and_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incoming</span><span class="p">):</span>
<span class="lineno"> 55</span>             <span class="k">try</span><span class="p">:</span>
<span class="lineno"> 56</span>                 <span class="n">incoming</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">incoming</span><span class="o">.</span><span class="n">ctxt</span><span class="p">,</span>
<span class="lineno"> 57</span>                                               <span class="n">incoming</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
<span class="lineno"> 58</span>             <span class="k">except</span> <span class="n">ExpectedException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="lineno"> 59</span>                 <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">u&#39;Expected exception during message handling (</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
<span class="lineno"> 60</span>                           <span class="n">e</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="lineno"> 61</span>                 <span class="n">incoming</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">failure</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">exc_info</span><span class="p">,</span> <span class="n">log_failure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno"> 62</span>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="lineno"> 63</span>                 <span class="c"># sys.exc_info() is deleted by LOG.exception().</span>
<span class="lineno"> 64</span>                 <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
<span class="lineno"> 65</span>                 <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Exception during message handling: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span>
<span class="lineno"> 66</span>                           <span class="n">exc_info</span><span class="o">=</span><span class="n">exc_info</span><span class="p">)</span>
<span class="lineno"> 67</span>                 <span class="n">incoming</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">failure</span><span class="o">=</span><span class="n">exc_info</span><span class="p">)</span>
<span class="lineno"> 68</span>                 <span class="c"># NOTE(dhellmann): Remove circular object reference</span>
<span class="lineno"> 69</span>                 <span class="c"># between the current stack frame and the traceback in</span>
<span class="lineno"> 70</span>                 <span class="c"># exc_info.</span>
<span class="lineno"> 71</span>                 <span class="k">del</span> <span class="n">exc_info</span>
<span class="lineno"> 72</span> 
<span class="lineno"> 73</span>         <span class="k">def</span> <span class="nf">_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="lineno"> 74</span>             <span class="sd">&quot;&quot;&quot;Dispatch an RPC message to the appropriate endpoint method.</span>
<span class="lineno"> 75</span> 
<span class="lineno"> 76</span> <span class="sd">            :param ctxt: the request context</span>
<span class="lineno"> 77</span> <span class="sd">            :type ctxt: dict</span>
<span class="lineno"> 78</span> <span class="sd">            :param message: the message payload</span>
<span class="lineno"> 79</span> <span class="sd">            :type message: dict</span>
<span class="lineno"> 80</span> <span class="sd">            :raises: NoSuchMethod, UnsupportedVersion</span>
<span class="lineno"> 81</span> <span class="sd">            &quot;&quot;&quot;</span>
<span class="lineno"> 82</span>             <span class="n">method</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;method&#39;</span><span class="p">)</span>
<span class="lineno"> 83</span>             <span class="n">args</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="lineno"> 84</span>             <span class="n">namespace</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;namespace&#39;</span><span class="p">)</span>
<span class="lineno"> 85</span>             <span class="n">version</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">,</span> <span class="s">&#39;1.0&#39;</span><span class="p">)</span>
<span class="lineno"> 86</span> 
<span class="lineno"> 87</span>             <span class="n">found_compatible</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno"> 88</span>             <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="p">:</span>
<span class="lineno"> 89</span>                 <span class="n">target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">&#39;target&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="lineno"> 90</span>                 <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
<span class="lineno"> 91</span>                     <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_target</span>
<span class="lineno"> 92</span> 
<span class="lineno"> 93</span>                 <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_namespace</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span> <span class="ow">and</span>
<span class="lineno"> 94</span>                         <span class="bp">self</span><span class="o">.</span><span class="n">_is_compatible</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">version</span><span class="p">)):</span>
<span class="lineno"> 95</span>                     <span class="k">continue</span>
<span class="lineno"> 96</span> 
<span class="lineno"> 97</span>                 <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span> <span class="c">#从endpoint中获取相应的rpc method</span>
<span class="lineno"> 98</span>                     <span class="n">localcontext</span><span class="o">.</span><span class="n">set_local_context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)</span> <span class="c">#执行rpc调用</span>
<span class="lineno"> 99</span>                     <span class="k">try</span><span class="p">:</span>
<span class="lineno">100</span>                         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_dispatch</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="c">#返回序列化的结果</span>
<span class="lineno">101</span>                     <span class="k">finally</span><span class="p">:</span>
<span class="lineno">102</span>                         <span class="n">localcontext</span><span class="o">.</span><span class="n">clear_local_context</span><span class="p">()</span>
<span class="lineno">103</span> 
<span class="lineno">104</span>                 <span class="n">found_compatible</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">105</span> 
<span class="lineno">106</span>             <span class="k">if</span> <span class="n">found_compatible</span><span class="p">:</span>
<span class="lineno">107</span>                 <span class="k">raise</span> <span class="n">NoSuchMethod</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
<span class="lineno">108</span>             <span class="k">else</span><span class="p">:</span>
<span class="lineno">109</span>                 <span class="k">raise</span> <span class="n">UnsupportedVersion</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span></code></pre></div>

<p>在__call__方法中, 返回的<a href="http://www.secnetix.de/olli/Python/lambda_functions.hawk">lambda</a>即为: self._dispatch_and_reply(incoming), 然后消息会在_dispatch函数中被处理并返回相应的
rpc调用的结果.</p>

<h3 id="transporttarget">Transport如何通过Target获取相应的消息</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">_listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
<span class="lineno">2</span>             <span class="k">return</span> <span class="n">transport</span><span class="o">.</span><span class="n">_listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">)</span></code></pre></div>

<p>在上面dispatcher的实现中, 可以看到_listen函数是通过tranport._listen实现的, 并相应的传递了self._target作为参数.
因此, 我们可以通过理解Transport的实现来理解openstack neutron中topic的含义.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Transport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span>         <span class="sd">&quot;&quot;&quot;A messaging transport.</span>
<span class="lineno"> 3</span> <span class="sd">        This is a mostly opaque handle for an underlying messaging transport</span>
<span class="lineno"> 4</span> <span class="sd">        driver.</span>
<span class="lineno"> 5</span> <span class="sd">        It has a single &#39;conf&#39; property which is the cfg.ConfigOpts instance used</span>
<span class="lineno"> 6</span> <span class="sd">        to construct the transport object.</span>
<span class="lineno"> 7</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 8</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
<span class="lineno"> 9</span>             <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">conf</span>
<span class="lineno">10</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span> <span class="o">=</span> <span class="n">driver</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>         <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">wait_for_reply</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
<span class="lineno">13</span>                   <span class="n">retry</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">14</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">:</span>
<span class="lineno">15</span>                 <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidTarget</span><span class="p">(</span><span class="s">&#39;A topic is required to send&#39;</span><span class="p">,</span>
<span class="lineno">16</span>                                                <span class="n">target</span><span class="p">)</span>
<span class="lineno">17</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span>
<span class="lineno">18</span>                                      <span class="n">wait_for_reply</span><span class="o">=</span><span class="n">wait_for_reply</span><span class="p">,</span>
<span class="lineno">19</span>                                      <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>         <span class="k">def</span> <span class="nf">_send_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">22</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">:</span>
<span class="lineno">23</span>                 <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidTarget</span><span class="p">(</span><span class="s">&#39;A topic is required to send&#39;</span><span class="p">,</span>
<span class="lineno">24</span>                                                <span class="n">target</span><span class="p">)</span>
<span class="lineno">25</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">send_notification</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span>
<span class="lineno">26</span>                                            <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>         <span class="k">def</span> <span class="nf">_listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="lineno">29</span>             <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">topic</span> <span class="ow">and</span> <span class="n">target</span><span class="o">.</span><span class="n">server</span><span class="p">):</span>
<span class="lineno">30</span>                 <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidTarget</span><span class="p">(</span><span class="s">&#39;A server</span><span class="se">\&#39;</span><span class="s">s target must have &#39;</span>
<span class="lineno">31</span>                                                <span class="s">&#39;topic and server names specified&#39;</span><span class="p">,</span>
<span class="lineno">32</span>                                                <span class="n">target</span><span class="p">)</span>
<span class="lineno">33</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driver</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="c">#相应的实现在driver中实现</span></code></pre></div>

<p>可以看到, 不同的transport都实现了listen函数, 以rabbitmq的实现为例, driver代码如下:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">  1</span> <span class="k">class</span> <span class="nc">AMQPDriverBase</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">BaseDriver</span><span class="p">):</span>
<span class="lineno">  2</span>     
<span class="lineno">  3</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span>
<span class="lineno">  4</span>                      <span class="n">default_exchange</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_remote_exmods</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">  5</span>             <span class="nb">super</span><span class="p">(</span><span class="n">AMQPDriverBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">default_exchange</span><span class="p">,</span>
<span class="lineno">  6</span>                                                  <span class="n">allowed_remote_exmods</span><span class="p">)</span>
<span class="lineno">  7</span>     
<span class="lineno">  8</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_default_exchange</span> <span class="o">=</span> <span class="n">default_exchange</span>
<span class="lineno">  9</span>     
<span class="lineno"> 10</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_connection_pool</span> <span class="o">=</span> <span class="n">connection_pool</span>
<span class="lineno"> 11</span>     
<span class="lineno"> 12</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="lineno"> 13</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno"> 14</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q_conn</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno"> 15</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_waiter</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno"> 16</span>     
<span class="lineno"> 17</span>         <span class="k">def</span> <span class="nf">_get_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="lineno"> 18</span>             <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">exchange</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_exchange</span>
<span class="lineno"> 19</span>     
<span class="lineno"> 20</span>         <span class="k">def</span> <span class="nf">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pooled</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno"> 21</span>             <span class="k">return</span> <span class="n">rpc_amqp</span><span class="o">.</span><span class="n">ConnectionContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_pool</span><span class="p">,</span>
<span class="lineno"> 22</span>                                               <span class="n">pooled</span><span class="o">=</span><span class="n">pooled</span><span class="p">)</span>
<span class="lineno"> 23</span>     
<span class="lineno"> 24</span>         <span class="k">def</span> <span class="nf">_get_reply_q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 25</span>             <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q_lock</span><span class="p">:</span>
<span class="lineno"> 26</span>                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno"> 27</span>                     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span>
<span class="lineno"> 28</span>     
<span class="lineno"> 29</span>                 <span class="n">reply_q</span> <span class="o">=</span> <span class="s">&#39;reply_&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
<span class="lineno"> 30</span>     
<span class="lineno"> 31</span>                 <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">(</span><span class="n">pooled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno"> 32</span>     
<span class="lineno"> 33</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_waiter</span> <span class="o">=</span> <span class="n">ReplyWaiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">reply_q</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span>
<span class="lineno"> 34</span>                                            <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_remote_exmods</span><span class="p">)</span>
<span class="lineno"> 35</span>     
<span class="lineno"> 36</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span> <span class="o">=</span> <span class="n">reply_q</span>
<span class="lineno"> 37</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q_conn</span> <span class="o">=</span> <span class="n">conn</span>
<span class="lineno"> 38</span>     
<span class="lineno"> 39</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span>
<span class="lineno"> 40</span>     
<span class="lineno"> 41</span>         <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span>
<span class="lineno"> 42</span>                   <span class="n">wait_for_reply</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
<span class="lineno"> 43</span>                   <span class="n">envelope</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno"> 44</span>     
<span class="lineno"> 45</span>             <span class="c"># FIXME(markmc): remove this temporary hack</span>
<span class="lineno"> 46</span>             <span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 47</span>                 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="lineno"> 48</span>                     <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
<span class="lineno"> 49</span>     
<span class="lineno"> 50</span>                 <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 51</span>                     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
<span class="lineno"> 52</span>     
<span class="lineno"> 53</span>             <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)</span>
<span class="lineno"> 54</span>             <span class="n">msg</span> <span class="o">=</span> <span class="n">message</span>
<span class="lineno"> 55</span>     
<span class="lineno"> 56</span>             <span class="k">if</span> <span class="n">wait_for_reply</span><span class="p">:</span>
<span class="lineno"> 57</span>                 <span class="n">msg_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
<span class="lineno"> 58</span>                 <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;_msg_id&#39;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">})</span>
<span class="lineno"> 59</span>                 <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;MSG_ID is </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>
<span class="lineno"> 60</span>                 <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;_reply_q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reply_q</span><span class="p">()})</span>
<span class="lineno"> 61</span>     
<span class="lineno"> 62</span>             <span class="n">rpc_amqp</span><span class="o">.</span><span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno"> 63</span>             <span class="n">rpc_amqp</span><span class="o">.</span><span class="n">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<span class="lineno"> 64</span>     
<span class="lineno"> 65</span>             <span class="k">if</span> <span class="n">envelope</span><span class="p">:</span>
<span class="lineno"> 66</span>                 <span class="n">msg</span> <span class="o">=</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno"> 67</span>     
<span class="lineno"> 68</span>             <span class="k">if</span> <span class="n">wait_for_reply</span><span class="p">:</span>
<span class="lineno"> 69</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_waiter</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
<span class="lineno"> 70</span>     
<span class="lineno"> 71</span>             <span class="k">try</span><span class="p">:</span>
<span class="lineno"> 72</span>                 <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="lineno"> 73</span>                     <span class="k">if</span> <span class="n">notify</span><span class="p">:</span>
<span class="lineno"> 74</span>                         <span class="n">conn</span><span class="o">.</span><span class="n">notify_send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_exchange</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
<span class="lineno"> 75</span>                                          <span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
<span class="lineno"> 76</span>                     <span class="k">elif</span> <span class="n">target</span><span class="o">.</span><span class="n">fanout</span><span class="p">:</span>
<span class="lineno"> 77</span>                         <span class="n">conn</span><span class="o">.</span><span class="n">fanout_send</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
<span class="lineno"> 78</span>                     <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 79</span>                         <span class="n">topic</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">topic</span>
<span class="lineno"> 80</span>                         <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>
<span class="lineno"> 81</span>                             <span class="n">topic</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
<span class="lineno"> 82</span>                         <span class="n">conn</span><span class="o">.</span><span class="n">topic_send</span><span class="p">(</span><span class="n">exchange_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_exchange</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
<span class="lineno"> 83</span>                                         <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
<span class="lineno"> 84</span>                                         <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
<span class="lineno"> 85</span>     
<span class="lineno"> 86</span>                 <span class="k">if</span> <span class="n">wait_for_reply</span><span class="p">:</span>
<span class="lineno"> 87</span>                     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="lineno"> 88</span>                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
<span class="lineno"> 89</span>                         <span class="k">raise</span> <span class="n">result</span>
<span class="lineno"> 90</span>                     <span class="k">return</span> <span class="n">result</span>
<span class="lineno"> 91</span>             <span class="k">finally</span><span class="p">:</span>
<span class="lineno"> 92</span>                 <span class="k">if</span> <span class="n">wait_for_reply</span><span class="p">:</span>
<span class="lineno"> 93</span>                     <span class="bp">self</span><span class="o">.</span><span class="n">_waiter</span><span class="o">.</span><span class="n">unlisten</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
<span class="lineno"> 94</span>     
<span class="lineno"> 95</span>         <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">wait_for_reply</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
<span class="lineno"> 96</span>                  <span class="n">retry</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno"> 97</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">wait_for_reply</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span>
<span class="lineno"> 98</span>                               <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
<span class="lineno"> 99</span>     
<span class="lineno">100</span>         <span class="k">def</span> <span class="nf">send_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">101</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span>
<span class="lineno">102</span>                               <span class="n">envelope</span><span class="o">=</span><span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">),</span> <span class="n">notify</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>
<span class="lineno">103</span>     
<span class="lineno">104</span>         <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="lineno">105</span>             <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">(</span><span class="n">pooled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno">106</span>     
<span class="lineno">107</span>             <span class="n">listener</span> <span class="o">=</span> <span class="n">AMQPListener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="lineno">108</span>     
<span class="lineno">109</span>             <span class="n">conn</span><span class="o">.</span><span class="n">declare_topic_consumer</span><span class="p">(</span><span class="n">exchange_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_exchange</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="c">#定义Topic Consumer</span>
<span class="lineno">110</span>                                         <span class="n">topic</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span>
<span class="lineno">111</span>                                         <span class="n">callback</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>
<span class="lineno">112</span>             <span class="n">conn</span><span class="o">.</span><span class="n">declare_topic_consumer</span><span class="p">(</span><span class="n">exchange_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_exchange</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
<span class="lineno">113</span>                                         <span class="n">topic</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span>
<span class="lineno">114</span>                                                          <span class="n">target</span><span class="o">.</span><span class="n">server</span><span class="p">),</span>
<span class="lineno">115</span>                                         <span class="n">callback</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>
<span class="lineno">116</span>             <span class="n">conn</span><span class="o">.</span><span class="n">declare_fanout_consumer</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span>
<span class="lineno">117</span>     
<span class="lineno">118</span>             <span class="k">return</span> <span class="n">listener</span>
<span class="lineno">119</span>     
<span class="lineno">120</span>         <span class="k">def</span> <span class="nf">listen_for_notifications</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets_and_priorities</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
<span class="lineno">121</span>             <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">(</span><span class="n">pooled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno">122</span>     
<span class="lineno">123</span>             <span class="n">listener</span> <span class="o">=</span> <span class="n">AMQPListener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="lineno">124</span>             <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">priority</span> <span class="ow">in</span> <span class="n">targets_and_priorities</span><span class="p">:</span>
<span class="lineno">125</span>                 <span class="n">conn</span><span class="o">.</span><span class="n">declare_topic_consumer</span><span class="p">(</span>
<span class="lineno">126</span>                     <span class="n">exchange_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_exchange</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
<span class="lineno">127</span>                     <span class="n">topic</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">priority</span><span class="p">),</span>
<span class="lineno">128</span>                     <span class="n">callback</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span> <span class="n">queue_name</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
<span class="lineno">129</span>             <span class="k">return</span> <span class="n">listener</span></code></pre></div>

<p>从上面listen的代码, 就回到了rpc call和rpc cast模型, 定义Topic Consumer, 但是为什么会初始化3个<code>Consumer</code>呢？</p>

<p>这要从rpc方法调用的方式说起, rpc call和 rpc cast有两种方式: topic + topic.host, rpc fanout_cast有一种方式: fanout, 所以对应的<code>Consumer</code>
也有3种, 因为在消息的接收方看来, 我不需要关心消息是以什么方式传输过来的, 无论是rpc call, 或者rpc cast, 或rpc fanout_cast, 对于
消息本身才是它需要关心的, 因此它可以接收三种方式发送过来的消息, 所以会初始化3种<code>Consumer</code>.</p>

<h3 id="section">总结</h3>

<p>结合RabbbitMQ的基本概念, 不难看出, openstack中与rpc调用相关的topic, 对消息发送方(rpc调用方)来说, 它就是
消息的<code>Routing Key</code>, 对于消息接收方(rpc接受方), 它就是初始化<code>Consumer</code>时用于接受消息的<code>Queue</code>的名称, 
且<code>Queue</code>与<code>Exchange</code>的Binding Key也为它.</p>

<h3 id="section-1">参考网站</h3>

<p>RabbitMQ:   <a href="http://www.rabbitmq.com/">http://www.rabbitmq.com/</a></p>


  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Sina Network Platform Team's blog</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Sina Network Platform Team's blog</li>
        <li><a href="mailto:np@staff.sina.com.cn">np@staff.sina.com.cn</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/sinanp">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">sinanp</span>
          </a>
        </li>
        <li>
          <a href="http://weibo.com/sinanp">
            <span class="icon weibo">
              <svg version="1.1" class="weibo-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 
                width="16px" height="16px" viewBox="0 0 90 90" enable-background="new 0 0 90 90" xml:space="preserve">
                <g>
                  <path d="M74.293,48.546c-1.361-0.407-2.296-0.686-1.582-2.474c1.543-3.887,1.702-7.238,0.028-9.629
                    c-3.139-4.484-11.729-4.243-21.574-0.121c0-0.005-3.092,1.354-2.301-1.1c1.515-4.868,1.286-8.945-1.07-11.3
                    c-5.341-5.346-19.545,0.202-31.729,12.379C6.944,45.424,1.647,55.093,1.647,63.453c0,15.993,20.509,25.715,40.572,25.715
                    c26.3,0,43.794-15.281,43.794-27.412C86.014,54.426,79.841,50.266,74.293,48.546z M42.272,83.437
                    c-16.008,1.579-29.828-5.655-30.868-16.167c-1.039-10.509,11.1-20.311,27.105-21.893c16.011-1.585,29.831,5.652,30.869,16.159
                    C70.416,72.05,58.282,81.854,42.272,83.437z"/>
                  <path d="M91.757,19.28L91.757,19.28c-6.351-7.041-15.719-9.724-24.366-7.886h-0.003c-1.999,0.427-3.276,2.396-2.847,4.394
                    c0.426,1.998,2.394,3.276,4.395,2.849c6.15-1.307,12.808,0.605,17.324,5.606c4.511,5.001,5.736,11.823,3.804,17.803l0.001,0.003
                    c-0.63,1.949,0.435,4.033,2.386,4.662c1.944,0.629,4.031-0.436,4.661-2.378c0-0.003,0-0.01,0.001-0.014
                    C99.824,35.903,98.111,26.314,91.757,19.28z"/>
                  <path d="M70.135,24.247c-1.723,0.366-2.821,2.062-2.449,3.785c0.367,1.716,2.062,2.819,3.778,2.445v0.003
                    c2.06-0.437,4.293,0.199,5.805,1.872c1.512,1.678,1.92,3.963,1.27,5.967h0.003c-0.54,1.673,0.375,3.471,2.051,4.015
                    c1.676,0.536,3.473-0.378,4.013-2.055c1.323-4.1,0.497-8.769-2.602-12.197C78.911,24.654,74.348,23.352,70.135,24.247z"/>
                  <polygon points="82.003,28.082 82.003,28.082 82.003,28.083  "/>
                  <path d="M43.872,53.465c-7.617-1.983-16.229,1.814-19.537,8.527c-3.369,6.846-0.112,14.445,7.584,16.931
                    c7.974,2.57,17.37-1.37,20.638-8.759C55.78,62.94,51.756,55.502,43.872,53.465z M38.055,70.949
                    c-1.549,2.47-4.863,3.552-7.362,2.412c-2.461-1.12-3.188-3.991-1.638-6.399c1.529-2.398,4.732-3.468,7.213-2.429
                    C38.773,65.603,39.576,68.452,38.055,70.949z M43.156,64.4c-0.56,0.959-1.798,1.419-2.768,1.02
                    c-0.954-0.392-1.253-1.463-0.711-2.404c0.558-0.936,1.748-1.393,2.699-1.016C43.344,62.354,43.69,63.438,43.156,64.4z"/>
                </g>
              </svg>
            </span>
            <span class="username">sinanp</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text"></p>
    </div>

  </div>

</footer>


    </body>
</html>